// PSILLYOPS PRISMA SCHEMA - SINGLE SOURCE OF TRUTH
// This schema defines all 14+ core entities for the inventory management system

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ========================================
// CANONICAL ENUMS
// ========================================

enum UserRole {
  ADMIN
  PRODUCTION
  WAREHOUSE
  REP
}

enum OrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  IN_FULFILLMENT
  SHIPPED
  CANCELLED
}

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}

enum UnitOfMeasure {
  GRAM
  KILOGRAM
  MILLILITER
  LITER
  UNIT
  EACH
  PACK
  BOX
}

enum MovementType {
  ADJUST
  MOVE
  CONSUME
  PRODUCE
  RECEIVE
  RETURN
  RESERVE
  RELEASE
}

enum QCStatus {
  NOT_REQUIRED
  PENDING
  HOLD
  PASSED
  FAILED
}

enum BatchStatus {
  PLANNED
  IN_PROGRESS
  QC_HOLD
  RELEASED
  EXHAUSTED
  CANCELLED
}

enum InventoryType {
  PRODUCT
  MATERIAL
}

enum InventoryStatus {
  AVAILABLE
  RESERVED
  QUARANTINED
  DAMAGED
  SCRAPPED
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum ActivityEntity {
  PRODUCT
  MATERIAL
  BATCH
  ORDER
  PRODUCTION_ORDER
  PRODUCTION_RUN
  PURCHASE_ORDER
  VENDOR
  INVENTORY
  WORK_CENTER
  INVOICE
  LABEL
  SYSTEM
}

enum ProductionRunStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProductionStepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum LabelEntityType {
  PRODUCT
  BATCH
  INVENTORY
  CUSTOM
}

enum QRTokenStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum PrintJobStatus {
  CREATED
  PAPER_USED
  VOIDED
}

enum InventoryAdjustmentType {
  PRODUCTION_COMPLETE
  PRODUCTION_SCRAP
  MANUAL_CORRECTION
  RECEIVING
  CONSUMPTION
}

// ========================================
// CORE MODELS
// ========================================

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  password      String
  role          UserRole @default(REP)
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Phase 2: User Management fields
  lastLoginAt   DateTime?
  passwordSetAt DateTime?
  
  // Relations
  createdOrders             RetailerOrder[]    @relation("OrderCreator")
  approvedOrders            RetailerOrder[]    @relation("OrderApprover")
  createdProductionOrders   ProductionOrder[]  @relation("ProductionOrderCreator")
  createdProductionRuns     ProductionRun[]    @relation("ProductionRunCreator")
  createdPurchaseOrders     PurchaseOrder[]    @relation("PurchaseOrderCreator")
  batches                   BatchMaker[]
  activityLogs              ActivityLog[]
  inventoryAdjustments      InventoryAdjustment[] @relation("UserInventoryAdjustments")
  assignedRetailers         Retailer[]
  laborEntries              LaborEntry[]
  productionRunSteps        ProductionRunStep[] @relation("ProductionRunStepPerformer")
  assignedProductionRunSteps ProductionRunStep[] @relation("ProductionRunStepAssignee")
  aiCommandLogs             AICommandLog[]
  aiDocumentImports         AIDocumentImport[]
  qrTokens                  QRToken[]
  qrRedirectRules           QRRedirectRule[]
  printJobs                 PrintJob[]
  
  @@index([email])
  @@index([role])
}

model Strain {
  id        String   @id @default(cuid())
  name      String   @unique           // "Penis Envy"
  shortCode String   @unique           // "PE"
  aliases   Json     @default("[]")    // ["P. Envy", "PenisEnvy"] - stored as JSON for SQLite compatibility
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  
  products  Product[]
  materials RawMaterial[]
  
  @@index([shortCode])
}

model Product {
  id                String   @id @default(cuid())
  name              String
  sku               String   @unique
  barcodeValue      String?  // Barcode value for label printing (defaults to SKU if null)
  unitOfMeasure     String
  defaultBatchSize  Int?
  leadTimeDays      Int      @default(0)
  reorderPoint      Int      @default(0)
  wholesalePrice    Float?   // Default wholesale price per unit
  strainId          String?  // Optional reference to strain
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  strain            Strain?  @relation(fields: [strainId], references: [id])
  bom               BOMItem[]
  inventory         InventoryItem[]
  orderLines        OrderLineItem[]
  productionOrders  ProductionOrder[]
  productionRuns    ProductionRun[]
  batches           Batch[]
  productionTemplates ProductionTemplate[]
  productionStepTemplates ProductionStepTemplate[]
  
  @@index([sku])
  @@index([active])
  @@index([strainId])
}

model ProductionStepTemplate {
  id        String   @id @default(cuid())

  productId String
  product   Product  @relation(fields: [productId], references: [id])

  key       String   // machine-friendly identifier (e.g. "mix", "encapsulate")
  label     String   // human-friendly label
  order     Int
  required  Boolean  @default(true)

  createdAt DateTime @default(now())

  @@unique([productId, key])
  @@unique([productId, order])
  @@index([productId, order])
}

model ProductionRun {
  id            String   @id @default(cuid())

  productId     String
  product       Product  @relation(fields: [productId], references: [id])

  quantity      Int
  status        ProductionRunStatus @default(PLANNED)

  qrTokenId     String?  @unique
  qrToken       QRToken? @relation("ProductionRunQrToken", fields: [qrTokenId], references: [id])

  startedAt     DateTime?
  completedAt   DateTime?

  createdById   String?
  createdBy     User?    @relation("ProductionRunCreator", fields: [createdById], references: [id])

  steps         ProductionRunStep[]

  createdAt     DateTime @default(now())

  @@index([productId])
}

model ProductionRunStep {
  id              String @id @default(cuid())

  productionRunId String
  productionRun   ProductionRun @relation(fields: [productionRunId], references: [id])

  templateKey     String
  label           String
  order           Int
  required        Boolean

  status          ProductionStepStatus @default(PENDING)

  startedAt       DateTime?
  completedAt     DateTime?
  skippedAt       DateTime?
  skipReason      String?

  performedById   String?
  performedBy     User? @relation("ProductionRunStepPerformer", fields: [performedById], references: [id])

  assignedToUserId String?
  assignedToUser   User? @relation("ProductionRunStepAssignee", fields: [assignedToUserId], references: [id])

  createdAt       DateTime @default(now())

  @@index([productionRunId, order])
}

model RawMaterial {
  id                String           @id @default(cuid())
  name              String
  sku               String           @unique
  unitOfMeasure     String
  category          String
  description       String?
  currentStockQty   Float            @default(0)
  reorderPoint      Float            @default(0)
  reorderQuantity   Float            @default(0)
  moq               Float            @default(0)
  leadTimeDays      Int              @default(0)
  shelfLifeDays     Int?
  expiryWarningDays Int?
  active            Boolean          @default(true)
  archivedAt        DateTime?        // Soft delete timestamp
  preferredVendorId String?
  strainId          String?          // Optional reference to strain
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  strain                    Strain?                   @relation(fields: [strainId], references: [id])
  preferredVendor           Vendor?                   @relation("PreferredVendor", fields: [preferredVendorId], references: [id])
  vendors                   MaterialVendor[]
  bomUsage                  BOMItem[]
  inventory                 InventoryItem[]
  poLineItems               PurchaseOrderLineItem[]
  costHistory               MaterialCostHistory[]
  attachments               MaterialAttachment[]
  productionOrderMaterials  ProductionOrderMaterial[]
  
  @@index([sku])
  @@index([active])
  @@index([preferredVendorId])
  @@index([category])
  @@index([strainId])
}

model Vendor {
  id                  String   @id @default(cuid())
  name                String
  contactName         String?
  contactEmail        String?
  contactPhone        String?
  address             String?
  paymentTerms        String?
  defaultLeadTimeDays Int      @default(0)
  notes               String?
  active              Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  materials         MaterialVendor[]
  purchaseOrders    PurchaseOrder[]
  preferredFor      RawMaterial[]         @relation("PreferredVendor")
  costHistory       MaterialCostHistory[]
  
  @@index([name])
  @@index([active])
}

model MaterialVendor {
  id            String   @id @default(cuid())
  materialId    String
  vendorId      String
  leadTimeDays  Int?
  lastPrice     Float?
  moq           Float    @default(0)
  preferred     Boolean  @default(false)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  material      RawMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  vendor        Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  @@unique([materialId, vendorId])
  @@index([materialId])
  @@index([vendorId])
  @@index([preferred])
}

model BOMItem {
  id              String   @id @default(cuid())
  productId       String
  materialId      String
  quantityPerUnit Float
  version         Int      @default(1)
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  
  product         Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  material        RawMaterial @relation(fields: [materialId], references: [id])
  
  @@unique([productId, materialId, version])
  @@index([productId])
  @@index([materialId])
}

model Location {
  id                  String   @id @default(cuid())
  name                String   @unique
  type                String
  isDefaultReceiving  Boolean  @default(false)
  isDefaultShipping   Boolean  @default(false)
  active              Boolean  @default(true)
  createdAt           DateTime @default(now())
  
  inventory           InventoryItem[]
  
  @@index([type])
}

model Batch {
  id                String      @id @default(cuid())
  productId         String
  batchCode         String      @unique
  plannedQuantity   Int
  actualQuantity    Int?
  status            BatchStatus @default(PLANNED)
  productionOrderId String?
  productionDate    DateTime?
  manufactureDate   DateTime?
  expirationDate    DateTime?
  expectedYield     Float?
  actualYield       Float?
  lossQty           Float?
  lossReason        String?
  qcStatus          QCStatus    @default(NOT_REQUIRED)
  notes             String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  product           Product            @relation(fields: [productId], references: [id])
  productionOrder   ProductionOrder?   @relation(fields: [productionOrderId], references: [id])
  makers            BatchMaker[]
  inventory         InventoryItem[]
  laborEntries      LaborEntry[]
  
  @@index([productId])
  @@index([status])
  @@index([batchCode])
  @@index([productionOrderId])
  @@index([qcStatus])
}

model BatchMaker {
  id        String   @id @default(cuid())
  batchId   String
  userId    String
  createdAt DateTime @default(now())
  
  batch     Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  user      User  @relation(fields: [userId], references: [id])
  
  @@unique([batchId, userId])
  @@index([batchId])
  @@index([userId])
}

model InventoryItem {
  id                String          @id @default(cuid())
  type              InventoryType
  productId         String?
  materialId        String?
  batchId           String?
  locationId        String
  quantityOnHand    Float
  quantityReserved  Float           @default(0)
  unitOfMeasure     String
  unitCost          Float?
  externalRef       String?
  status            InventoryStatus @default(AVAILABLE)
  lotNumber         String?
  expiryDate        DateTime?
  source            String          @default("MANUAL")
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  product           Product?      @relation(fields: [productId], references: [id])
  material          RawMaterial?  @relation(fields: [materialId], references: [id])
  batch             Batch?        @relation(fields: [batchId], references: [id])
  location          Location      @relation(fields: [locationId], references: [id])
  adjustments       InventoryAdjustment[] @relation("InventoryItemAdjustments")
  
  @@index([type])
  @@index([productId])
  @@index([materialId])
  @@index([batchId])
  @@index([locationId])
  @@index([status])
  @@index([expiryDate])
}

model Retailer {
  id              String   @id @default(cuid())
  name            String
  contactEmail    String?
  contactPhone    String?
  shippingAddress String?
  billingAddress  String?
  notes           String?
  salesRepId      String?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  salesRep        User?           @relation(fields: [salesRepId], references: [id])
  orders          RetailerOrder[]
  invoices        Invoice[]
  
  @@index([salesRepId])
  @@index([name])
}

model RetailerOrder {
  id                String      @id @default(cuid())
  orderNumber       String      @unique
  retailerId        String
  createdByUserId   String
  status            OrderStatus @default(DRAFT)
  requestedShipDate DateTime?
  approvedByUserId  String?
  approvedAt        DateTime?
  shippedAt         DateTime?
  trackingNumber    String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  retailer          Retailer         @relation(fields: [retailerId], references: [id])
  createdBy         User             @relation("OrderCreator", fields: [createdByUserId], references: [id])
  approvedBy        User?            @relation("OrderApprover", fields: [approvedByUserId], references: [id])
  lineItems         OrderLineItem[]
  invoices          Invoice[]
  
  @@index([retailerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdByUserId])
}

model OrderLineItem {
  id                  String   @id @default(cuid())
  orderId             String
  productId           String
  quantityOrdered     Int
  quantityAllocated   Int      @default(0)
  shortageQuantity    Int      @default(0)
  allocationDetails   Json?
  unitWholesalePrice  Float?   // Snapshotted at order submission
  lineTotal           Float?   // Snapshotted at order submission (qty * price)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  order               RetailerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product             Product       @relation(fields: [productId], references: [id])
  
  @@index([orderId])
  @@index([productId])
}

model ProductionOrder {
  id                      String           @id @default(cuid())
  orderNumber             String           @unique
  productId               String
  quantityToMake          Int
  batchSize               Float?
  status                  ProductionStatus @default(PLANNED)
  scheduledDate           DateTime?
  dueDate                 DateTime?
  startedAt               DateTime?
  completedAt             DateTime?
  workCenterId            String?
  templateId              String?
  createdByUserId         String
  linkedRetailerOrderIds  Json?
  materialRequirements    Json?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  
  product                 Product                   @relation(fields: [productId], references: [id])
  createdBy               User                      @relation("ProductionOrderCreator", fields: [createdByUserId], references: [id])
  workCenter              WorkCenter?               @relation(fields: [workCenterId], references: [id])
  template                ProductionTemplate?       @relation(fields: [templateId], references: [id])
  batches                 Batch[]
  materials               ProductionOrderMaterial[]
  
  @@index([productId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdByUserId])
  @@index([workCenterId])
  @@index([scheduledDate])
}

model PurchaseOrder {
  id                    String               @id @default(cuid())
  poNumber              String               @unique
  vendorId              String
  status                PurchaseOrderStatus  @default(DRAFT)
  createdByUserId       String
  sentAt                DateTime?
  expectedDeliveryDate  DateTime?
  receivedAt            DateTime?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  
  vendor                Vendor                    @relation(fields: [vendorId], references: [id])
  createdBy             User                      @relation("PurchaseOrderCreator", fields: [createdByUserId], references: [id])
  lineItems             PurchaseOrderLineItem[]
  
  @@index([vendorId])
  @@index([status])
  @@index([poNumber])
  @@index([createdByUserId])
}

model PurchaseOrderLineItem {
  id                String   @id @default(cuid())
  purchaseOrderId   String
  materialId        String
  quantityOrdered   Float
  quantityReceived  Float    @default(0)
  unitCost          Float?
  lotNumber         String?
  expiryDate        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  material          RawMaterial   @relation(fields: [materialId], references: [id])
  
  @@index([purchaseOrderId])
  @@index([materialId])
}

model ActivityLog {
  id          String         @id @default(cuid())
  entityType  ActivityEntity? // Phase 1: Made nullable for auth logs
  entityId    String?         // Phase 1: Made nullable for auth logs
  action      String
  userId      String?
  ipAddress   String?         // Phase 1: Added for auth tracking
  userAgent   String?         // Phase 1: Added for auth tracking
  summary     String
  diff        Json?
  metadata    Json?           // Phase 1: Renamed from 'details'
  tags        Json?
  createdAt   DateTime       @default(now())
  
  user        User?  @relation(fields: [userId], references: [id])
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([tags])
  @@index([action])
}

model InventoryAdjustment {
  id                 String                  @id @default(cuid())
  inventoryId        String
  inventory          InventoryItem           @relation("InventoryItemAdjustments", fields: [inventoryId], references: [id])

  deltaQty           Int
  reason             String
  adjustmentType     InventoryAdjustmentType

  relatedEntityType  ActivityEntity?
  relatedEntityId    String?

  createdById        String?
  createdBy          User?                   @relation("UserInventoryAdjustments", fields: [createdById], references: [id])

  createdAt          DateTime                @default(now())

  @@index([inventoryId])
  @@index([createdAt])
}

// ========================================
// MATERIAL COST & ATTACHMENT TRACKING
// ========================================

model MaterialCostHistory {
  id          String      @id @default(cuid())
  materialId  String
  vendorId    String?
  price       Float
  source      String      @default("MANUAL") // MANUAL, PO, IMPORT, etc.
  notes       String?
  createdAt   DateTime    @default(now())
  
  material    RawMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  vendor      Vendor?     @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  
  @@index([materialId])
  @@index([vendorId])
  @@index([createdAt])
}

model MaterialAttachment {
  id          String      @id @default(cuid())
  materialId  String
  fileName    String
  fileUrl     String
  fileType    String      @default("OTHER") // COA, MSDS, SPEC, OTHER
  notes       String?
  uploadedAt  DateTime    @default(now())
  
  material    RawMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  
  @@index([materialId])
  @@index([fileType])
}

// ========================================
// INVENTORY MOVEMENTS & PRODUCTION TRACKING
// ========================================

model InventoryMovement {
  id           String       @id @default(cuid())
  inventoryId  String?
  materialId   String?
  productId    String?
  batchId      String?
  type         MovementType
  quantity     Float
  fromLocation String?
  toLocation   String?
  reason       String?
  reference    String?
  userId       String?
  createdAt    DateTime     @default(now())
  
  @@index([materialId])
  @@index([productId])
  @@index([batchId])
  @@index([inventoryId])
  @@index([type])
  @@index([createdAt])
}

model ProductionOrderMaterial {
  id                String          @id @default(cuid())
  productionOrderId String
  materialId        String
  requiredQty       Float
  issuedQty         Float           @default(0)
  shortage          Float           @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  material          RawMaterial     @relation(fields: [materialId], references: [id])
  
  @@unique([productionOrderId, materialId])
  @@index([productionOrderId])
  @@index([materialId])
}

model WorkCenter {
  id               String            @id @default(cuid())
  name             String
  description      String?
  active           Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  productionOrders ProductionOrder[]
  
  @@index([active])
}

model ProductionTemplate {
  id               String            @id @default(cuid())
  name             String
  productId        String
  defaultBatchSize Float
  instructions     String?
  active           Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  product          Product           @relation(fields: [productId], references: [id])
  productionOrders ProductionOrder[]
  
  @@index([productId])
  @@index([active])
}

model LaborEntry {
  id        String   @id @default(cuid())
  batchId   String
  userId    String
  minutes   Int
  role      String?
  notes     String?
  createdAt DateTime @default(now())
  
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
  
  @@index([batchId])
  @@index([userId])
  @@index([createdAt])
}

model UnitConversion {
  id         String        @id @default(cuid())
  fromUnit   UnitOfMeasure
  toUnit     UnitOfMeasure
  multiplier Float
  
  @@unique([fromUnit, toUnit])
}

// ========================================
// AI COMMAND & DOCUMENT INGEST
// ========================================

model AICommandLog {
  id               String    @id @default(cuid())
  userId           String?
  inputText        String
  normalized       String?   // Short normalized command name, e.g. "RECEIVE_MATERIAL"
  status           String    // "PENDING", "CONFIRMED", "APPLIED", "FAILED"
  aiResult         Json?     // Raw AI response / parsed structure
  executedPayload  Json?     // Final executed command payload after resolution
  correctedCommand Json?     // User-corrected command if they edited it
  error            String?
  createdAt        DateTime  @default(now())
  appliedAt        DateTime?
  
  user             User?     @relation(fields: [userId], references: [id])
  
  @@index([status])
  @@index([createdAt])
}

model AIDocumentImport {
  id           String    @id @default(cuid())
  userId       String?
  sourceType   String    // "UPLOAD", "PASTE", "EMAIL"
  originalName String?
  contentType  String?
  textPreview  String?
  status       String    // "PENDING_REVIEW", "PARSED", "APPLIED", "REJECTED", "FAILED"
  confidence   Float?
  aiResult     Json?     // Parsed structured data and commands
  createdAt    DateTime  @default(now())
  reviewedAt   DateTime?
  appliedAt    DateTime?
  error        String?
  
  user         User?     @relation(fields: [userId], references: [id])
  
  @@index([status])
  @@index([createdAt])
}

// ========================================
// INVOICING
// ========================================

model Invoice {
  id          String   @id @default(cuid())
  invoiceNo   String   @unique
  orderId     String
  retailerId  String
  issuedAt    DateTime @default(now())
  subtotal    Float
  notes       String?
  
  order       RetailerOrder @relation(fields: [orderId], references: [id])
  retailer    Retailer      @relation(fields: [retailerId], references: [id])
  
  @@index([orderId])
  @@index([retailerId])
  @@index([invoiceNo])
  @@index([issuedAt])
}

// ========================================
// LABEL TEMPLATES & VERSIONING
// ========================================

model LabelTemplate {
  id          String          @id @default(cuid())
  name        String
  entityType  LabelEntityType
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  versions    LabelTemplateVersion[]
  
  @@index([entityType])
}

model LabelTemplateVersion {
  id          String        @id @default(cuid())
  templateId  String
  version     String        // e.g., "1.0", "1.1", "2.0"
  fileUrl     String        // Relative path to SVG file
  qrTemplate  String?       // e.g., https://psillyops.app/qr/batch/{{id}}
  
  // Unified Placement System
  // Stores PlaceableElement[] - all QR codes and barcodes with absolute inch positions
  // See lib/types/placement.ts for type definitions
  elements    Json?
  
  // Label canvas size override (inches)
  labelWidthIn   Float?
  labelHeightIn  Float?

  isActive    Boolean       @default(false)
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime?     // When elements or settings were last updated
  
  template    LabelTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tokens      QRToken[]
  
  @@unique([templateId, version])
  @@index([templateId])
  @@index([isActive])
}

// ========================================
// QR TOKEN SYSTEM
// ========================================

model QRToken {
  id              String          @id @default(cuid())
  token           String          @unique    // Opaque token (e.g., "qr_2x7kP9mN4...")
  
  status          QRTokenStatus   @default(ACTIVE)
  
  // Entity reference (polymorphic via type + id pattern)
  entityType      LabelEntityType            // PRODUCT, BATCH, INVENTORY, CUSTOM
  entityId        String                     // ID of the referenced entity
  
  // Label context
  versionId       String?                    // Which label version was printed
  version         LabelTemplateVersion?      @relation(fields: [versionId], references: [id])
  
  // Token-level redirect (highest precedence)
  redirectUrl     String?                    // Override destination URL for this specific token
  
  // Timestamps
  printedAt       DateTime        @default(now())  // When the label was generated
  expiresAt       DateTime?                        // Optional expiration
  revokedAt       DateTime?                        // When revoked (if applicable)
  revokedReason   String?                          // Why revoked (recall, error, etc.)
  
  // Analytics (lightweight)
  scanCount       Int             @default(0)      // Total scans
  lastScannedAt   DateTime?                        // Most recent scan
  
  // Audit
  createdByUserId String?
  createdBy       User?           @relation(fields: [createdByUserId], references: [id])

  // Optional linkage to a ProductionRun (Phase 5)
  productionRun   ProductionRun?  @relation("ProductionRunQrToken")
  
  @@index([token])
  @@index([entityType, entityId])
  @@index([status])
  @@index([versionId])
  @@index([printedAt])
}

// ========================================
// QR REDIRECT RULES (Group-based Redirects)
// ========================================

model QRRedirectRule {
  id          String   @id @default(cuid())

  // Scope selectors (exactly one set of selectors must be provided)
  entityType  LabelEntityType?   // Target entity type (PRODUCT, BATCH, etc.)
  entityId    String?            // Target entity ID
  versionId   String?            // Target label template version

  redirectUrl String             // Where to redirect matching scans

  active      Boolean  @default(true)  // Only active rules are applied

  // Optional metadata
  reason      String?            // Why this redirect exists (recall, campaign, etc.)
  startsAt    DateTime?          // Optional scheduled start time
  endsAt      DateTime?          // Optional scheduled end time

  // Audit
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])

  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([versionId])
  @@index([active])
}

model PrintJob {
  id              String          @id @default(cuid())
  status          PrintJobStatus  @default(CREATED)
  sheets          Int
  paperMaterialId String?
  paperUsedAt     DateTime?
  
  // Context
  entityType      LabelEntityType
  entityId        String
  versionId       String
  quantity        Int             // Number of labels printed
  
  // Audit
  createdById     String?
  createdBy       User?           @relation(fields: [createdById], references: [id])
  createdAt       DateTime        @default(now())
  
  @@index([entityType, entityId])
  @@index([status])
  @@index([createdAt])
}

