generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String                @id @default(cuid())
  name                       String
  email                      String                @unique
  password                   String
  role                       UserRole              @default(REP)
  active                     Boolean               @default(true)
  createdAt                  DateTime              @default(now())
  updatedAt                  DateTime              @updatedAt
  lastLoginAt                DateTime?
  passwordSetAt              DateTime?
  aiCommandLogs              AICommandLog[]
  aiDocumentImports          AIDocumentImport[]
  activityLogs               ActivityLog[]
  batches                    BatchMaker[]
  inventoryAdjustments       InventoryAdjustment[] @relation("UserInventoryAdjustments")
  laborEntries               LaborEntry[]
  printJobs                  PrintJob[]
  createdProductionOrders    ProductionOrder[]     @relation("ProductionOrderCreator")
  assignedProductionOrders   ProductionOrder[]     @relation("ProductionOrderAssignee")
  assignerProductionOrders   ProductionOrder[]     @relation("ProductionOrderAssigner")
  createdProductionRuns      ProductionRun[]       @relation("ProductionRunCreator")
  assignedProductionRuns     ProductionRun[]       @relation("ProductionRunAssignee")
  assignerProductionRuns     ProductionRun[]       @relation("ProductionRunAssigner")
  assignedProductionRunSteps ProductionRunStep[]   @relation("ProductionRunStepAssignee")
  productionRunSteps         ProductionRunStep[]   @relation("ProductionRunStepPerformer")
  createdPurchaseOrders      PurchaseOrder[]       @relation("PurchaseOrderCreator")
  qrRedirectRules            QRRedirectRule[]
  qrTokens                   QRToken[]
  assignedRetailers          Retailer[]
  approvedOrders             RetailerOrder[]       @relation("OrderApprover")
  createdOrders              RetailerOrder[]       @relation("OrderCreator")
  aiReviewedOrders           RetailerOrder[]       @relation("OrderAIReviewer")
  predictionProfiles         PredictionProfile[]
  partnerId                  String?
  partner                    Partner?              @relation(fields: [partnerId], references: [id])
  createdSealSheets          SealSheet[]           @relation("SealSheetCreator")
  assignedSealSheets         SealSheet[]           @relation("SealSheetAssigner")
  experienceBindings         ExperienceBinding[]   @relation("ExperienceBindingBoundBy")
  bindingSessions            BindingSession[]      @relation("BindingSessionStartedBy")
  createdAIProposals         AIProposal[]          @relation("AIProposalCreator")
  executedAIProposals        AIProposal[]          @relation("AIProposalExecutor")
  aiSessions                 AISession[]

  @@index([email])
  @@index([role])
  @@index([partnerId])
}

model Strain {
  id        String        @id @default(cuid())
  name      String        @unique
  shortCode String        @unique
  aliases   Json          @default("[]")
  active    Boolean       @default(true)
  createdAt DateTime      @default(now())
  products  Product[]
  materials RawMaterial[]

  @@index([shortCode])
}

model Product {
  id                      String                   @id @default(cuid())
  name                    String
  sku                     String                   @unique
  unitOfMeasure           String
  defaultBatchSize        Int?
  leadTimeDays            Int                      @default(0)
  reorderPoint            Int                      @default(0)
  wholesalePrice          Float?
  strainId                String?
  defaultLocationId       String?
  active                  Boolean                  @default(true)
  defaultExperienceMode   ExperienceMode           @default(MACRO)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  barcodeValue            String?
  labelHeightIn           Float?
  labelPrintQuantity      Int?
  labelWidthIn            Float?
  sheetMarginTopBottomIn  Float?
  upc                     String?
  // Public-facing fields for QR pages
  publicImageUrl          String?
  publicDescription       String?
  // Manufacturing configuration
  manufacturingSteps      Json?                    // Array of {key, label, order, required, dependsOnKeys[], estimatedMinutes}
  requiredEquipment       Json?                    // Array of strings: ["Scale", "Mixer", "Capsule Machine"]
  bom                     BOMItem[]
  batches                 Batch[]
  inventory               InventoryItem[]
  orderLines              OrderLineItem[]
  strain                  Strain?                  @relation(fields: [strainId], references: [id])
  defaultLocation         Location?                @relation("ProductDefaultLocation", fields: [defaultLocationId], references: [id])
  productionOrders        ProductionOrder[]
  productionRuns          ProductionRun[]
  productionStepTemplates ProductionStepTemplate[]
  productionTemplates     ProductionTemplate[]
  predictionProfiles      PredictionProfile[]
  experienceReviews       ExperienceReview[]
  labels                  ProductLabel[]
  tripdarTokens           TripdarToken[]

  @@index([sku])
  @@index([upc])
  @@index([active])
  @@index([strainId])
  @@index([defaultLocationId])
}

model ProductionStepTemplate {
  id        String   @id @default(cuid())
  productId String
  key       String
  label     String
  order     Int
  required  Boolean  @default(true)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])

  @@unique([productId, key])
  @@unique([productId, order])
  @@index([productId, order])
}

model ProductionRun {
  id                 String              @id @default(cuid())
  productId          String
  productionOrderId  String?
  quantity           Int
  status             ProductionRunStatus @default(PLANNED)
  qrTokenId          String?             @unique
  startedAt          DateTime?
  completedAt        DateTime?
  createdById        String?
  assignedToUserId   String?
  assignedByUserId   String?
  assignedAt         DateTime?
  assignmentReason   String?
  createdAt          DateTime            @default(now())
  createdBy          User?               @relation("ProductionRunCreator", fields: [createdById], references: [id])
  assignedTo         User?               @relation("ProductionRunAssignee", fields: [assignedToUserId], references: [id])
  assignedBy         User?               @relation("ProductionRunAssigner", fields: [assignedByUserId], references: [id])
  product            Product             @relation(fields: [productId], references: [id])
  productionOrder    ProductionOrder?    @relation(fields: [productionOrderId], references: [id])
  qrToken            QRToken?            @relation("ProductionRunQrToken", fields: [qrTokenId], references: [id])
  steps              ProductionRunStep[]
  batches            Batch[]             @relation("ProductionRunBatches")

  @@index([productId])
  @@index([productionOrderId])
  @@index([assignedToUserId])
  @@index([status])
}

model ProductionRunStep {
  id               String               @id @default(cuid())
  productionRunId  String
  templateKey      String
  label            String
  order            Int
  required         Boolean
  stepType         String               @default("INSTRUCTION") // INSTRUCTION, MATERIAL_ISSUE, EQUIPMENT_CHECK
  dependsOnKeys    Json?                // Array of templateKey strings this step depends on
  estimatedMinutes Int?
  materialId       String?              // For MATERIAL_ISSUE steps
  materialQty      Float?               // For MATERIAL_ISSUE steps
  status           ProductionStepStatus @default(PENDING)
  startedAt        DateTime?
  completedAt      DateTime?
  skippedAt        DateTime?
  skipReason       String?
  performedById    String?
  assignedToUserId String?
  createdAt        DateTime             @default(now())
  assignedToUser   User?                @relation("ProductionRunStepAssignee", fields: [assignedToUserId], references: [id])
  performedBy      User?                @relation("ProductionRunStepPerformer", fields: [performedById], references: [id])
  productionRun    ProductionRun        @relation(fields: [productionRunId], references: [id])
  material         RawMaterial?         @relation(fields: [materialId], references: [id])

  @@index([productionRunId, order])
  @@index([materialId])
}

model RawMaterial {
  id                       String                    @id @default(cuid())
  name                     String
  sku                      String                    @unique
  unitOfMeasure            String
  category                 String
  description              String?
  currentStockQty          Float                     @default(0)
  reorderPoint             Float                     @default(0)
  reorderQuantity          Float                     @default(0)
  moq                      Float                     @default(0)
  leadTimeDays             Int                       @default(0)
  shelfLifeDays            Int?
  expiryWarningDays        Int?
  active                   Boolean                   @default(true)
  archivedAt               DateTime?
  preferredVendorId        String?
  strainId                 String?
  defaultLocationId        String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  upc                      String?
  bomUsage                 BOMItem[]
  inventory                InventoryItem[]
  attachments              MaterialAttachment[]
  costHistory              MaterialCostHistory[]
  vendors                  MaterialVendor[]
  productionOrderMaterials ProductionOrderMaterial[]
  productionRunSteps       ProductionRunStep[]
  poLineItems              PurchaseOrderLineItem[]
  preferredVendor          Vendor?                   @relation("PreferredVendor", fields: [preferredVendorId], references: [id])
  strain                   Strain?                   @relation(fields: [strainId], references: [id])
  defaultLocation          Location?                 @relation("MaterialDefaultLocation", fields: [defaultLocationId], references: [id])

  @@index([sku])
  @@index([upc])
  @@index([active])
  @@index([preferredVendorId])
  @@index([category])
  @@index([strainId])
  @@index([defaultLocationId])
}

model Vendor {
  id                  String                @id @default(cuid())
  name                String
  contactName         String?
  contactEmail        String?
  contactPhone        String?
  address             String?
  paymentTerms        String?
  defaultLeadTimeDays Int                   @default(0)
  notes               String?
  active              Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  costHistory         MaterialCostHistory[]
  materials           MaterialVendor[]
  purchaseOrders      PurchaseOrder[]
  preferredFor        RawMaterial[]         @relation("PreferredVendor")

  @@index([name])
  @@index([active])
}

model MaterialVendor {
  id           String      @id @default(cuid())
  materialId   String
  vendorId     String
  leadTimeDays Int?
  lastPrice    Float?
  moq          Float       @default(0)
  preferred    Boolean     @default(false)
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  material     RawMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  vendor       Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([materialId, vendorId])
  @@index([materialId])
  @@index([vendorId])
  @@index([preferred])
}

model BOMItem {
  id              String      @id @default(cuid())
  productId       String
  materialId      String
  quantityPerUnit Float
  version         Int         @default(1)
  active          Boolean     @default(true)
  createdAt       DateTime    @default(now())
  material        RawMaterial @relation(fields: [materialId], references: [id])
  product         Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, materialId, version])
  @@index([productId])
  @@index([materialId])
}

model Location {
  id                  String          @id @default(cuid())
  name                String          @unique
  type                String
  parentId            String?
  isDefaultReceiving  Boolean         @default(false)
  isDefaultShipping   Boolean         @default(false)
  active              Boolean         @default(true)
  createdAt           DateTime        @default(now())
  parent              Location?       @relation("LocationHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children            Location[]      @relation("LocationHierarchy")
  inventory           InventoryItem[]
  defaultForProducts  Product[]       @relation("ProductDefaultLocation")
  defaultForMaterials RawMaterial[]   @relation("MaterialDefaultLocation")

  @@index([type])
  @@index([parentId])
}

model Batch {
  id                String             @id @default(cuid())
  productId         String
  batchCode         String             @unique
  plannedQuantity   Int
  actualQuantity    Int?
  status            BatchStatus        @default(PLANNED)
  productionOrderId String?
  productionRunId   String?
  productionDate    DateTime?
  manufactureDate   DateTime?
  expirationDate    DateTime?
  expectedYield     Float?
  actualYield       Float?
  lossQty           Float?
  lossReason        String?
  qcStatus          QCStatus           @default(NOT_REQUIRED)
  notes             String?
  coaUrl            String?            // URL to Certificate of Analysis PDF
  coaUploadedAt     DateTime?          // When COA was uploaded
  qualityData       Json?              // Quality overview data for public display
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  product           Product            @relation(fields: [productId], references: [id])
  productionOrder   ProductionOrder?   @relation(fields: [productionOrderId], references: [id])
  productionRun     ProductionRun?     @relation("ProductionRunBatches", fields: [productionRunId], references: [id])
  makers            BatchMaker[]
  inventory         InventoryItem[]
  laborEntries      LaborEntry[]
  experienceReviews ExperienceReview[]
  tripdarTokens     TripdarToken[]

  @@index([productId])
  @@index([status])
  @@index([batchCode])
  @@index([productionOrderId])
  @@index([productionRunId])
  @@index([qcStatus])
}

model BatchMaker {
  id        String   @id @default(cuid())
  batchId   String
  userId    String
  createdAt DateTime @default(now())
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([batchId, userId])
  @@index([batchId])
  @@index([userId])
}

model InventoryItem {
  id               String                @id @default(cuid())
  type             InventoryType
  productId        String?
  materialId       String?
  batchId          String?
  locationId       String
  quantityOnHand   Float
  quantityReserved Float                 @default(0)
  unitOfMeasure    String
  unitCost         Float?
  externalRef      String?
  status           InventoryStatus       @default(AVAILABLE)
  lotNumber        String?
  expiryDate       DateTime?
  source           String                @default("MANUAL")
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  adjustments      InventoryAdjustment[] @relation("InventoryItemAdjustments")
  batch            Batch?                @relation(fields: [batchId], references: [id])
  location         Location              @relation(fields: [locationId], references: [id])
  material         RawMaterial?          @relation(fields: [materialId], references: [id])
  product          Product?              @relation(fields: [productId], references: [id])

  @@index([type])
  @@index([productId])
  @@index([materialId])
  @@index([batchId])
  @@index([locationId])
  @@index([status])
  @@index([expiryDate])
}

model Retailer {
  id              String          @id @default(cuid())
  name            String
  contactEmail    String?
  contactPhone    String?
  shippingAddress String?
  billingAddress  String?
  notes           String?
  salesRepId      String?
  active          Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  invoices        Invoice[]
  salesRep        User?           @relation(fields: [salesRepId], references: [id])
  orders          RetailerOrder[]

  @@index([salesRepId])
  @@index([name])
}

model RetailerOrder {
  id                   String          @id @default(cuid())
  orderNumber          String          @unique
  retailerId           String
  createdByUserId      String
  status               OrderStatus     @default(DRAFT)
  requestedShipDate    DateTime?
  approvedByUserId     String?
  approvedAt           DateTime?
  shippedAt            DateTime?
  trackingNumber       String?
  carrier              String?
  createdByAI          Boolean         @default(false)
  aiReviewedAt         DateTime?
  aiReviewedByUserId   String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  invoices             Invoice[]
  lineItems            OrderLineItem[]
  approvedBy           User?           @relation("OrderApprover", fields: [approvedByUserId], references: [id])
  createdBy            User            @relation("OrderCreator", fields: [createdByUserId], references: [id])
  aiReviewer           User?           @relation("OrderAIReviewer", fields: [aiReviewedByUserId], references: [id], onDelete: SetNull)
  retailer             Retailer        @relation(fields: [retailerId], references: [id])

  @@index([retailerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdByUserId])
  @@index([createdByAI])
}

model OrderLineItem {
  id                 String        @id @default(cuid())
  orderId            String
  productId          String
  quantityOrdered    Int
  quantityAllocated  Int           @default(0)
  shortageQuantity   Int           @default(0)
  allocationDetails  Json?
  unitWholesalePrice Float?
  lineTotal          Float?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  order              RetailerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product            Product       @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model ProductionOrder {
  id                     String                    @id @default(cuid())
  orderNumber            String                    @unique
  productId              String
  quantityToMake         Int
  batchSize              Float?
  status                 ProductionStatus          @default(PLANNED)
  scheduledDate          DateTime?
  dueDate                DateTime?
  startedAt              DateTime?
  completedAt            DateTime?
  archivedAt             DateTime?
  archiveReason          String?
  dismissedAt            DateTime?
  workCenterId           String?
  templateId             String?
  createdByUserId        String
  assignedToUserId       String?
  assignedByUserId       String?
  assignedAt             DateTime?
  assignmentReason       String?
  linkedRetailerOrderIds Json?
  materialRequirements   Json?
  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @updatedAt
  batches                Batch[]
  productionRuns         ProductionRun[]
  createdBy              User                      @relation("ProductionOrderCreator", fields: [createdByUserId], references: [id])
  assignedTo             User?                     @relation("ProductionOrderAssignee", fields: [assignedToUserId], references: [id])
  assignedBy             User?                     @relation("ProductionOrderAssigner", fields: [assignedByUserId], references: [id])
  product                Product                   @relation(fields: [productId], references: [id])
  template               ProductionTemplate?       @relation(fields: [templateId], references: [id])
  workCenter             WorkCenter?               @relation(fields: [workCenterId], references: [id])
  materials              ProductionOrderMaterial[]

  @@index([productId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdByUserId])
  @@index([assignedToUserId])
  @@index([workCenterId])
  @@index([scheduledDate])
  @@index([archivedAt])
  @@index([dismissedAt])
  @@index([completedAt])
}

model PurchaseOrder {
  id                   String                  @id @default(cuid())
  poNumber             String                  @unique
  vendorId             String
  status               PurchaseOrderStatus     @default(DRAFT)
  createdByUserId      String
  sentAt               DateTime?
  expectedDeliveryDate DateTime?
  receivedAt           DateTime?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  createdBy            User                    @relation("PurchaseOrderCreator", fields: [createdByUserId], references: [id])
  vendor               Vendor                  @relation(fields: [vendorId], references: [id])
  lineItems            PurchaseOrderLineItem[]

  @@index([vendorId])
  @@index([status])
  @@index([poNumber])
  @@index([createdByUserId])
}

model PurchaseOrderLineItem {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  materialId       String
  quantityOrdered  Float
  quantityReceived Float         @default(0)
  unitCost         Float?
  lotNumber        String?
  expiryDate       DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  material         RawMaterial   @relation(fields: [materialId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([materialId])
}

model ActivityLog {
  id         String          @id @default(cuid())
  entityType ActivityEntity?
  entityId   String?
  action     String
  userId     String?
  summary    String
  diff       Json?
  tags       Json?
  createdAt  DateTime        @default(now())
  ipAddress  String?
  metadata   Json?
  userAgent  String?
  user       User?           @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([tags])
  @@index([action])
}

model InventoryAdjustment {
  id                String                  @id @default(cuid())
  inventoryId       String
  deltaQty          Int
  reason            String
  adjustmentType    InventoryAdjustmentType
  relatedEntityType ActivityEntity?
  relatedEntityId   String?
  createdById       String?
  createdAt         DateTime                @default(now())
  createdBy         User?                   @relation("UserInventoryAdjustments", fields: [createdById], references: [id])
  inventory         InventoryItem           @relation("InventoryItemAdjustments", fields: [inventoryId], references: [id])

  @@index([inventoryId])
  @@index([createdAt])
}

model MaterialCostHistory {
  id         String      @id @default(cuid())
  materialId String
  vendorId   String?
  price      Float
  source     String      @default("MANUAL")
  notes      String?
  createdAt  DateTime    @default(now())
  material   RawMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  vendor     Vendor?     @relation(fields: [vendorId], references: [id])

  @@index([materialId])
  @@index([vendorId])
  @@index([createdAt])
}

model MaterialAttachment {
  id         String      @id @default(cuid())
  materialId String
  fileName   String
  fileUrl    String
  fileType   String      @default("OTHER")
  notes      String?
  uploadedAt DateTime    @default(now())
  material   RawMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@index([fileType])
}

model InventoryMovement {
  id           String       @id @default(cuid())
  inventoryId  String?
  materialId   String?
  productId    String?
  batchId      String?
  type         MovementType
  quantity     Float
  fromLocation String?
  toLocation   String?
  reason       String?
  reference    String?
  userId       String?
  createdAt    DateTime     @default(now())

  @@index([materialId])
  @@index([productId])
  @@index([batchId])
  @@index([inventoryId])
  @@index([type])
  @@index([createdAt])
}

model ProductionOrderMaterial {
  id                String          @id @default(cuid())
  productionOrderId String
  materialId        String
  requiredQty       Float
  issuedQty         Float           @default(0)
  shortage          Float           @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  material          RawMaterial     @relation(fields: [materialId], references: [id])
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)

  @@unique([productionOrderId, materialId])
  @@index([productionOrderId])
  @@index([materialId])
}

model WorkCenter {
  id               String            @id @default(cuid())
  name             String
  description      String?
  active           Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  productionOrders ProductionOrder[]

  @@index([active])
}

model ProductionTemplate {
  id               String            @id @default(cuid())
  name             String
  productId        String
  defaultBatchSize Float
  instructions     String?
  active           Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  productionOrders ProductionOrder[]
  product          Product           @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([active])
}

model LaborEntry {
  id        String   @id @default(cuid())
  batchId   String
  userId    String
  minutes   Int
  role      String?
  notes     String?
  createdAt DateTime @default(now())
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([batchId])
  @@index([userId])
  @@index([createdAt])
}

model UnitConversion {
  id         String        @id @default(cuid())
  fromUnit   UnitOfMeasure
  toUnit     UnitOfMeasure
  multiplier Float

  @@unique([fromUnit, toUnit])
}

model AICommandLog {
  id               String    @id @default(cuid())
  userId           String?
  inputText        String
  normalized       String?
  status           String
  aiResult         Json?
  executedPayload  Json?
  correctedCommand Json?
  error            String?
  createdAt        DateTime  @default(now())
  appliedAt        DateTime?
  user             User?     @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([createdAt])
}

// ========================================
// AI Proposal System (Phase 1)
// ========================================

model AIProposal {
  id              String           @id @default(cuid())

  // Core identity
  action          String           // e.g. INVENTORY_ADJUSTMENT, PURCHASE_ORDER_SUBMIT, VENDOR_EMAIL
  executionMode   String           // EXECUTABLE | PREVIEW_ONLY
  phase           Int              // Phase this proposal was created under (1)

  // Proposal payload
  params          Json             // Normalized input parameters
  preview         Json             // Computed before/after preview shown to user
  warnings        Json?            // Optional warnings (e.g. large delta)

  // Authority & state
  status          AIProposalStatus @default(PENDING)
  phase1Allowed   Boolean          @default(false)

  // Session & attribution
  aiSessionId     String
  origin          String?          // "chatgpt", "voice", "ui" - for future analysis
  createdByUserId String
  createdByUser   User             @relation("AIProposalCreator", fields: [createdByUserId], references: [id])

  // Lifecycle
  expiresAt       DateTime
  executedAt      DateTime?
  executedByUserId String?
  executedByUser   User?           @relation("AIProposalExecutor", fields: [executedByUserId], references: [id])

  // Governance
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([aiSessionId])
  @@index([status])
  @@index([action])
  @@index([expiresAt])
  @@index([createdByUserId])
}

model AISession {
  id              String   @id @default(cuid())
  sessionToken    String   @unique
  userId          String
  origin          String?  // "chatgpt", "voice", "ui"
  createdAt       DateTime @default(now())
  lastActivityAt  DateTime @default(now())
  expiresAt       DateTime
  
  user            User     @relation(fields: [userId], references: [id])

  @@index([sessionToken])
  @@index([userId])
  @@index([expiresAt])
}

model AIDocumentImport {
  id           String    @id @default(cuid())
  userId       String?
  sourceType   String
  originalName String?
  contentType  String?
  textPreview  String?
  status       String
  confidence   Float?
  aiResult     Json?
  createdAt    DateTime  @default(now())
  reviewedAt   DateTime?
  appliedAt    DateTime?
  error        String?
  user         User?     @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([createdAt])
}

model Invoice {
  id         String        @id @default(cuid())
  invoiceNo  String        @unique
  orderId    String
  retailerId String
  issuedAt   DateTime      @default(now())
  subtotal   Float
  notes      String?
  order      RetailerOrder @relation(fields: [orderId], references: [id])
  retailer   Retailer      @relation(fields: [retailerId], references: [id])

  @@index([orderId])
  @@index([retailerId])
  @@index([invoiceNo])
  @@index([issuedAt])
}

model LabelTemplate {
  id         String                 @id @default(cuid())
  name       String
  entityType LabelEntityType
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
  versions   LabelTemplateVersion[]
  products   ProductLabel[]

  @@index([entityType])
}

model ProductLabel {
  id                    String        @id @default(cuid())
  productId             String
  templateId            String
  isQrCarrier           Boolean       @default(false)
  isBarcodeCarrier      Boolean       @default(false)
  createdAt             DateTime      @default(now())
  // Per-template print settings
  labelPrintQuantity    Int?
  sheetMarginTopBottomIn Float?
  labelWidthIn          Float?
  labelHeightIn         Float?

  product    Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  template   LabelTemplate @relation(fields: [templateId], references: [id])

  @@unique([productId, templateId])
  @@index([templateId])
}

model LabelTemplateVersion {
  id            String        @id @default(cuid())
  templateId    String
  version       String
  fileUrl       String
  qrTemplate    String?
  labelWidthIn  Float?
  labelHeightIn Float?
  isActive      Boolean       @default(false)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime?
  elements      Json?
  template      LabelTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tokens        QRToken[]

  @@unique([templateId, version])
  @@index([templateId])
  @@index([isActive])
}

model QRToken {
  id                String                @id @default(cuid())
  token             String                @unique
  status            QRTokenStatus         @default(ACTIVE)
  entityType        LabelEntityType
  entityId          String
  versionId         String?
  redirectUrl       String?
  printedAt         DateTime              @default(now())
  expiresAt         DateTime?
  revokedAt         DateTime?
  revokedReason     String?
  scanCount         Int                   @default(0)
  lastScannedAt     DateTime?
  createdByUserId   String?
  productionRun     ProductionRun?        @relation("ProductionRunQrToken")
  createdBy         User?                 @relation(fields: [createdByUserId], references: [id])
  version           LabelTemplateVersion? @relation(fields: [versionId], references: [id])
  experienceReviews ExperienceReview[]
  sealSheetId       String?
  metadata          Json?
  sealSheet         SealSheet?            @relation(fields: [sealSheetId], references: [id])
  experienceBinding ExperienceBinding?

  @@index([token])
  @@index([entityType, entityId])
  @@index([status])
  @@index([versionId])
  @@index([printedAt])
  @@index([sealSheetId])
}

model QRRedirectRule {
  id          String           @id @default(cuid())
  entityType  LabelEntityType?
  entityId    String?
  versionId   String?
  redirectUrl String
  active      Boolean          @default(true)
  reason      String?
  startsAt    DateTime?
  endsAt      DateTime?
  createdById String?
  createdAt   DateTime         @default(now())
  isFallback  Boolean          @default(false)
  updatedAt   DateTime         @updatedAt
  createdBy   User?            @relation(fields: [createdById], references: [id])

  @@index([entityType, entityId])
  @@index([versionId])
  @@index([active])
  @@index([isFallback])
}

model PrintJob {
  id              String          @id @default(cuid())
  status          PrintJobStatus  @default(CREATED)
  sheets          Int
  paperMaterialId String?
  paperUsedAt     DateTime?
  entityType      LabelEntityType
  entityId        String
  versionId       String
  quantity        Int
  createdById     String?
  createdAt       DateTime        @default(now())
  createdBy       User?           @relation(fields: [createdById], references: [id])

  @@index([entityType, entityId])
  @@index([status])
  @@index([createdAt])
}

model Lab {
  id                  String               @id @default(cuid())
  name                String
  location            String
  description         String?
  active              Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  transparencyRecords TransparencyRecord[]
}

model TransparencyRecord {
  id                String              @id @default(cuid())
  entityType        ActivityEntity
  entityId          String
  productionDate    DateTime
  batchCode         String?
  labId             String?
  labNameSnapshot   String
  testDate          DateTime?
  testResult        TransparencyResult?
  rawMaterialLinked Boolean             @default(true)
  publicDescription String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  lab               Lab?                @relation(fields: [labId], references: [id])

  @@index([entityType, entityId, testDate])
  @@index([labId])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

enum UserRole {
  ADMIN
  ANALYST
  PRODUCTION
  WAREHOUSE
  REP
  PARTNER_ADMIN
  PARTNER_OPERATOR
}

enum OrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  IN_FULFILLMENT
  SHIPPED
  CANCELLED
}

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}

enum UnitOfMeasure {
  GRAM
  KILOGRAM
  MILLILITER
  LITER
  UNIT
  EACH
  PACK
  BOX
}

enum MovementType {
  ADJUST
  MOVE
  CONSUME
  PRODUCE
  RECEIVE
  RETURN
  RESERVE
  RELEASE
}

enum QCStatus {
  NOT_REQUIRED
  PENDING
  HOLD
  PASSED
  FAILED
}

enum BatchStatus {
  PLANNED
  IN_PROGRESS
  QC_HOLD
  RELEASED
  EXHAUSTED
  CANCELLED
}

enum InventoryType {
  PRODUCT
  MATERIAL
}

enum InventoryStatus {
  AVAILABLE
  RESERVED
  QUARANTINED
  DAMAGED
  SCRAPPED
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum ActivityEntity {
  PRODUCT
  MATERIAL
  BATCH
  ORDER
  PRODUCTION_ORDER
  PRODUCTION_RUN
  PURCHASE_ORDER
  VENDOR
  INVENTORY
  WORK_CENTER
  INVOICE
  LABEL
  LOCATION
  SYSTEM
}

enum ProductionRunStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProductionStepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum LabelEntityType {
  PRODUCT
  BATCH
  INVENTORY
  CUSTOM
}

enum QRTokenStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum PrintJobStatus {
  CREATED
  GENERATED
  CONFIRMED
  CANCELLED
  PAPER_USED
  VOIDED
}

enum InventoryAdjustmentType {
  PRODUCTION_COMPLETE
  PRODUCTION_SCRAP
  MANUAL_CORRECTION
  RECEIVING
  CONSUMPTION
}

enum TransparencyResult {
  PASS
  PENDING
  FAIL
}

enum ExperienceMode {
  MICRO
  MACRO
}

enum PartnerStatus {
  ACTIVE
  SUSPENDED
}

enum SealSheetStatus {
  UNASSIGNED
  ASSIGNED
  REVOKED
}

enum BindingSource {
  MOBILE_ASSIGNMENT
  ADMIN_UI
}

enum VibesOwnerType {
  PSILLYOPS
  PARTNER
}

enum ProductType {
  PARTNER
  PSILLYOPS
}

enum SessionStatus {
  ACTIVE
  EXPIRED
  TERMINATED
}

enum AIProposalStatus {
  PENDING     // Created, awaiting confirmation
  APPLIED     // Successfully executed
  EXPIRED     // TTL elapsed before execution
  BLOCKED     // Phase gate blocked execution
  FAILED      // Execution attempted but failed
}

model PredictionProfile {
  id             String             @id @default(cuid())
  productId      String
  product        Product            @relation(fields: [productId], references: [id])
  experienceMode ExperienceMode     @default(MACRO)
  transcend      Float              @default(0)
  energize       Float              @default(0)
  create         Float              @default(0)
  transform      Float              @default(0)
  connect        Float              @default(0)
  vocabVersion   Int                @default(1)
  createdAt      DateTime           @default(now())
  createdById    String?
  createdBy      User?              @relation(fields: [createdById], references: [id])
  archivedAt     DateTime?
  reviews        ExperienceReview[]

  @@index([productId])
  @@index([productId, experienceMode])
  @@index([createdAt])
}

model ExperienceReview {
  id                  String             @id @default(cuid())
  qrTokenId           String?
  qrToken             QRToken?           @relation(fields: [qrTokenId], references: [id])
  productId           String
  product             Product            @relation(fields: [productId], references: [id])
  batchId             String?
  batch               Batch?             @relation(fields: [batchId], references: [id])
  predictionProfileId String?
  predictionProfile   PredictionProfile? @relation(fields: [predictionProfileId], references: [id])
  experienceMode      ExperienceMode     @default(MACRO)
  reviewSource        String             @default("transparency_page")
  overallMatch        Int?
  deltaTranscend      Int?
  deltaEnergize       Int?
  deltaCreate         Int?
  deltaTransform      Int?
  deltaConnect        Int?
  isFirstTime         Boolean?
  doseBandGrams       String?
  doseRelative        String?
  setting             String?
  note                String?            @db.VarChar(500)
  deviceHash          String
  geoCountry          String?
  geoRegion           String?
  integrityFlags      Json?
  contentFlags        Json?
  questionsAnswered   Int                @default(0)
  questionsSkipped    Int                @default(0)
  completionRate      Float              @default(0)
  createdAt           DateTime           @default(now())

  @@index([productId])
  @@index([productId, experienceMode])
  @@index([batchId])
  @@index([deviceHash])
  @@index([createdAt])
  @@index([overallMatch])
}

model DeviceScanLog {
  id         String   @id @default(cuid())
  deviceHash String
  tokenId    String?
  action     String
  createdAt  DateTime @default(now())

  @@index([deviceHash, createdAt])
  @@index([tokenId, createdAt])
}

// ========================================
// Phase 2B: Partner & Assignment Layer
// ========================================

model Partner {
  id        String        @id @default(cuid())
  name      String
  status    PartnerStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  users           User[]
  sealSheets      SealSheet[]
  products        PartnerProduct[]
  bindings        ExperienceBinding[]
  vibesProfiles   VibesProfile[]
  bindingSessions BindingSession[]
  tripdarTokens   TripdarToken[]

  @@index([status])
}

model SealSheet {
  id           String          @id @default(cuid())
  sealVersion  String
  status       SealSheetStatus @default(UNASSIGNED)
  tokenCount   Int
  tokensHash   String
  createdAt    DateTime        @default(now())
  createdById  String
  assignedAt   DateTime?
  assignedById String?
  partnerId    String?

  createdBy     User           @relation("SealSheetCreator", fields: [createdById], references: [id])
  assignedBy    User?          @relation("SealSheetAssigner", fields: [assignedById], references: [id])
  partner       Partner?       @relation(fields: [partnerId], references: [id])
  tokens        QRToken[]
  tripdarTokens TripdarToken[] @relation("TripdarTokenSealSheet")

  @@index([partnerId])
  @@index([status])
  @@index([tokensHash])
}

model PartnerProduct {
  id             String   @id @default(cuid())
  partnerId      String
  name           String
  sku            String?
  vibesProfileId String?
  createdAt      DateTime @default(now())

  partner         Partner             @relation(fields: [partnerId], references: [id])
  vibesProfile    VibesProfile?       @relation(fields: [vibesProfileId], references: [id])
  bindings        ExperienceBinding[]
  bindingSessions BindingSession[]

  @@unique([partnerId, name])
  @@index([partnerId])
}

// UNIFIED VibesProfile model (replaces separate PredictionProfile + PartnerVibesProfile)
// ownerType determines who owns the profile:
// - PSILLYOPS: System-wide defaults, ownerId is null
// - PARTNER: Partner-specific, ownerId references Partner.id
model VibesProfile {
  id          String         @id @default(cuid())
  ownerType   VibesOwnerType
  ownerId     String?
  name        String
  mode        ExperienceMode
  predictions Json
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  partner         Partner?            @relation(fields: [ownerId], references: [id])
  partnerProducts PartnerProduct[]
  bindings        ExperienceBinding[]

  @@unique([ownerType, ownerId, name])
  @@index([ownerType])
  @@index([ownerId])
  @@index([active])
}

// ExperienceBinding uses product-agnostic reference pattern
// productType + productRefId replaces nullable polymorphic FKs
// This avoids Prisma polymorphism pain and keeps integrity in service layer
model ExperienceBinding {
  id               String        @id @default(cuid())
  sealTokenId      String        @unique
  partnerId        String
  productType      ProductType
  productRefId     String
  vibesProfileId   String?
  boundAt          DateTime      @default(now())
  boundVia         BindingSource
  boundById        String
  // Phase 2C: Session-aware binding
  bindingSessionId  String?
  isRebind          Boolean       @default(false)
  previousBindingId String?

  sealToken        QRToken          @relation(fields: [sealTokenId], references: [id])
  partner          Partner          @relation(fields: [partnerId], references: [id])
  vibesProfile     VibesProfile?    @relation(fields: [vibesProfileId], references: [id])
  boundBy          User             @relation("ExperienceBindingBoundBy", fields: [boundById], references: [id])
  partnerProduct   PartnerProduct?  @relation(fields: [partnerProductId], references: [id])
  partnerProductId String?
  bindingSession   BindingSession?  @relation(fields: [bindingSessionId], references: [id])

  @@index([partnerId])
  @@index([productType, productRefId])
  @@index([vibesProfileId])
  @@index([bindingSessionId])
}

// Phase 2C: Binding Session for mobile batch binding
model BindingSession {
  id               String        @id @default(cuid())
  partnerId        String
  partnerProductId String
  startedById      String
  startedAt        DateTime      @default(now())
  expiresAt        DateTime
  endedAt          DateTime?
  status           SessionStatus @default(ACTIVE)
  scanCount        Int           @default(0)

  partner        Partner             @relation(fields: [partnerId], references: [id])
  partnerProduct PartnerProduct      @relation(fields: [partnerProductId], references: [id])
  startedBy      User                @relation("BindingSessionStartedBy", fields: [startedById], references: [id])
  bindings       ExperienceBinding[]

  @@index([partnerId])
  @@index([status])
}

// ========================================
// Seal Tuning & Calibration System
// ========================================

// Saved seal presets for the tuner UI
// Stores complete SporeFieldConfig snapshots
model SealPreset {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  basePreset  String           // 'dot-zones' | 'zone-system' | 'module-masked' | 'material-unified'
  parentId    String?          // Reference to parent preset if this is a child
  config      Json             // Full SporeFieldConfig object
  isLive      Boolean          @default(false)  // Only one preset can be live at a time
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdById String?

  parent   SealPreset?  @relation("PresetParent", fields: [parentId], references: [id])
  children SealPreset[] @relation("PresetParent")

  @@index([basePreset])
  @@index([isLive])
  @@index([parentId])
}

// ========================================
// TripDAR Public Token System
// ========================================
// Greenfield public QR system for tripd.ar
// Completely separate from legacy QRToken system

enum TripdarTokenStatus {
  UNBOUND   // Generated, not yet assigned to product
  ACTIVE    // In circulation, scannable
  REVOKED   // Administratively revoked
  EXPIRED   // Past expiration date
}

model TripdarToken {
  id            String             @id @default(cuid())

  // The short public token embedded in the QR (Base62, 5-6 chars)
  // This is the ONLY identifier exposed to users via tripd.ar/{publicToken}
  publicToken   String             @unique

  status        TripdarTokenStatus @default(UNBOUND)

  // Optional bindings (only Ops knows these internal IDs)
  partnerId     String?
  productId     String?
  batchId       String?
  sealSheetId   String?

  // Lifecycle timestamps
  createdAt     DateTime           @default(now())
  activatedAt   DateTime?          // When first scanned or bound
  revokedAt     DateTime?
  revokedReason String?
  expiresAt     DateTime?

  // Analytics (Ops is canonical source)
  lastScannedAt DateTime?
  scanCount     Int                @default(0)

  // Relations
  partner       Partner?           @relation(fields: [partnerId], references: [id])
  product       Product?           @relation(fields: [productId], references: [id])
  batch         Batch?             @relation(fields: [batchId], references: [id])
  sealSheet     SealSheet?         @relation("TripdarTokenSealSheet", fields: [sealSheetId], references: [id])

  surveyResponses TripdarSurveyResponse[]

  @@index([publicToken])
  @@index([status])
  @@index([createdAt])
  @@index([sealSheetId])
  @@index([productId])
  @@index([partnerId])
  @@index([batchId])
}

model TripdarSurveyResponse {
  id            String       @id @default(cuid())

  tokenId       String
  token         TripdarToken @relation(fields: [tokenId], references: [id])

  // Denormalized for query convenience (avoids join for rate limiting)
  publicToken   String

  // Survey context
  experienceMode String?

  // Payload from Tripd.ar (validated & bounded JSON)
  responses     Json

  // Abuse detection signals (optional, privacy-conscious)
  ipHash        String?      // Hashed IP, not raw
  fingerprint   String?      // Device fingerprint from client

  createdAt     DateTime     @default(now())

  @@index([publicToken])
  @@index([tokenId])
  @@index([createdAt])
}
